{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///Users/azarmacbook/Cursor%20Projects/PMP-%20Reports/src/lib/db.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient();\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma; "],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SAAS,gBAAgB,MAAM,IAAI,IAAI,6IAAY;AAEhE,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 74, "column": 0}, "map": {"version":3,"sources":["file:///Users/azarmacbook/Cursor%20Projects/PMP-%20Reports/src/app/api/admin/projects/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { z } from 'zod';\nimport { prisma } from '@/lib/db';\n\n// Default checklist template\nconst defaultChecklistTemplate = [\n  { phase: 'Project LOA (Letter of Award)', isSubItem: false },\n  { phase: 'Commencement Date', isSubItem: false },\n  { phase: 'Budget Kick-Off Between Project Manager and Tendering Revenue, Budget, Gross', isSubItem: false },\n  { phase: 'Contract Signing Between Kabri and Client', isSubItem: false },\n  { phase: 'Project Facilities Approval from the Bank', isSubItem: false },\n  { phase: 'Submission of Project Bonds and Insurances', isSubItem: false },\n  { phase: 'Performance Bond', isSubItem: true, parentPhase: 'Submission of Project Bonds and Insurances' },\n  { phase: 'Advance Bond', isSubItem: true, parentPhase: 'Submission of Project Bonds and Insurances' },\n  { phase: 'Insurances', isSubItem: true, parentPhase: 'Submission of Project Bonds and Insurances' },\n  { phase: 'Project Program of Work with Client', isSubItem: false },\n  { phase: 'Project Program of Work with Internal Target', isSubItem: false },\n  { phase: 'Project Organizational Chart', isSubItem: false },\n  { phase: 'Project Resources Sheet', isSubItem: false },\n  { phase: 'Design Tracker', isSubItem: false },\n  { phase: 'Authority NOCs Tracker (No Objection Certificates)', isSubItem: false },\n  { phase: 'Project Detailed Budget', isSubItem: false },\n  { phase: 'Project Cash Flow', isSubItem: false },\n  { phase: 'Project Code and ERP Matrix', isSubItem: false },\n  { phase: 'Engineering Phase Submissions (E1 Log Sheet)', isSubItem: false },\n  { phase: 'Procurement Phase Long Lead Items (E2 Log Sheet)', isSubItem: false },\n  { phase: 'Project Quality', isSubItem: false },\n  { phase: 'Project Risk Matrix', isSubItem: false },\n  { phase: 'Project Close-Out', isSubItem: false },\n];\n\n// Get checklist template (from database or fallback to default)\nasync function getChecklistTemplate() {\n  try {\n    const activeTemplate = await prisma.checklistTemplate.findFirst({\n      where: { isActive: true },\n      orderBy: { updatedAt: 'desc' },\n    });\n\n    if (activeTemplate && activeTemplate.items) {\n      return activeTemplate.items as any[];\n    }\n  } catch (error) {\n    console.error('Error fetching checklist template:', error);\n  }\n\n  return defaultChecklistTemplate;\n}\n\nconst projectSchema = z.object({\n  projectCode: z.string().min(1, 'Project code is required'),\n  projectName: z.string().min(1, 'Project name is required'),\n  projectDescription: z.string().optional().or(z.literal('')),\n  clientId: z.number().optional(),\n  projectManagementConsultantId: z.number().optional(),\n  designConsultantId: z.number().optional(),\n  supervisionConsultantId: z.number().optional(),\n  costConsultantId: z.number().optional(),\n  projectDirectorId: z.number().optional(),\n  projectManagerId: z.number().optional(),\n  startDate: z.string().optional().or(z.null()),\n  endDate: z.string().optional().or(z.null()),\n  duration: z.string().optional().or(z.literal('')),\n  eot: z.string().optional().or(z.literal('')),\n  projectValue: z.number().positive().optional().or(z.null()),\n  contacts: z.array(z.object({\n    contactId: z.number(),\n    isPrimary: z.boolean().default(false),\n    consultantType: z.string().optional(), // 'pmc', 'design', 'supervision', 'cost'\n  })).optional().default([]),\n});\n\n// GET - Fetch all projects\nexport async function GET() {\n  try {\n    const projects = await prisma.project.findMany({\n      include: {\n        client: true,\n        projectManagementConsultant: true,\n        designConsultant: true,\n        supervisionConsultant: true,\n        costConsultant: true,\n        projectPositions: {\n          include: {\n            staffAssignments: {\n              include: {\n                staff: true,\n              },\n            },\n          },\n        },\n      },\n      orderBy: {\n        createdAt: 'desc',\n      },\n    });\n\n    return NextResponse.json({ success: true, data: projects });\n  } catch (error) {\n    console.error('Error fetching projects:', error);\n    return NextResponse.json(\n      { success: false, error: 'Failed to fetch projects' },\n      { status: 500 }\n    );\n  }\n}\n\n// POST - Create new project\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const validatedData = projectSchema.parse(body);\n\n    // Extract contacts and staff fields from validated data\n    const { contacts, projectDirectorId, projectManagerId, ...projectData } = validatedData;\n\n    // Convert date strings to DateTime objects if provided\n    const projectDataWithDates = {\n      ...projectData,\n      startDate: projectData.startDate ? new Date(projectData.startDate) : null,\n      endDate: projectData.endDate ? new Date(projectData.endDate) : null,\n    };\n\n    // Use transaction to create project and contacts atomically\n    const result = await prisma.$transaction(async (tx) => {\n      // Create the project first\n      const project = await tx.project.create({\n        data: projectDataWithDates,\n        include: {\n          client: true,\n          projectManagementConsultant: true,\n          designConsultant: true,\n          supervisionConsultant: true,\n          costConsultant: true,\n          projectPositions: {\n            include: {\n              staffAssignments: {\n                include: {\n                  staff: true,\n                },\n              },\n            },\n          },\n        },\n      });\n\n      // Create project contacts if any are provided\n      if (contacts && contacts.length > 0) {\n        // Use upsert to handle potential duplicates\n        for (const contact of contacts) {\n          await tx.projectContact.upsert({\n            where: {\n              projectId_contactId_consultantType: {\n                projectId: project.id,\n                contactId: contact.contactId,\n                consultantType: contact.consultantType || 'pmc', // Default to 'pmc' if not specified\n              },\n            },\n            update: {\n              isPrimary: contact.isPrimary,\n              consultantType: contact.consultantType || undefined,\n            },\n            create: {\n              projectId: project.id,\n              contactId: contact.contactId,\n              isPrimary: contact.isPrimary,\n              consultantType: contact.consultantType || undefined,\n            },\n          });\n        }\n      }\n\n      // Auto-initialize checklist for the new project\n      const checklistTemplate = await getChecklistTemplate();\n      const createdItems: { [key: string]: number } = {}; // Store created item IDs by phase name\n      \n      // Create items in template order to maintain proper hierarchy\n      let orderCounter = 0;\n      for (const template of checklistTemplate) {\n        if (!template.isSubItem) {\n          // Create parent item\n          const item = await tx.projectChecklistItem.create({\n            data: {\n              projectId: project.id,\n              itemNumber: '', // Empty item number since we're not using numbers\n              phase: template.phase,\n              status: 'Pending',\n              isSubItem: false,\n              parentItemId: null,\n              order: orderCounter++,\n            },\n          });\n          createdItems[template.phase] = item.id;\n        } else if (template.isSubItem && template.parentPhase) {\n          // Create sub-item immediately after its parent\n          const parentId = createdItems[template.parentPhase];\n          if (parentId) {\n            await tx.projectChecklistItem.create({\n              data: {\n                projectId: project.id,\n                itemNumber: '', // Empty item number since we're not using numbers\n                phase: template.phase,\n                status: 'Pending',\n                isSubItem: true,\n                parentItemId: parentId,\n                order: orderCounter++,\n              },\n            });\n          }\n        }\n      }\n\n      // Create ProjectPosition entries for director and manager if provided\n      if (projectDirectorId) {\n        const directorPosition = await tx.projectPosition.create({\n          data: {\n            projectId: project.id,\n            designation: 'Project Director',\n            requiredUtilization: 100,\n          },\n        });\n        \n        await tx.projectStaff.create({\n          data: {\n            projectId: project.id,\n            positionId: directorPosition.id,\n            staffId: projectDirectorId,\n            utilization: 100,\n            status: 'Active',\n            startDate: projectDataWithDates.startDate,\n            endDate: projectDataWithDates.endDate,\n          },\n        });\n      }\n\n      if (projectManagerId) {\n        const managerPosition = await tx.projectPosition.create({\n          data: {\n            projectId: project.id,\n            designation: 'Project Manager',\n            requiredUtilization: 100,\n          },\n        });\n        \n        await tx.projectStaff.create({\n          data: {\n            projectId: project.id,\n            positionId: managerPosition.id,\n            staffId: projectManagerId,\n            utilization: 100,\n            status: 'Active',\n            startDate: projectDataWithDates.startDate,\n            endDate: projectDataWithDates.endDate,\n          },\n        });\n      }\n\n      // Create default positions for the project from positions pool\n      const activePositions = await tx.position.findMany({\n        where: { isActive: true },\n        orderBy: { name: 'asc' }\n      });\n\n      // Create default positions (without staff assigned)\n      for (const position of activePositions) {\n        // Skip if this position is already created as director or manager\n        if ((position.name === 'Project Director' && projectDirectorId) || \n            (position.name === 'Project Manager' && projectManagerId)) {\n          continue;\n        }\n\n        await tx.projectPosition.create({\n          data: {\n            projectId: project.id,\n            designation: position.name,\n            requiredUtilization: 100, // Default to 100% requirement\n          },\n        });\n      }\n\n      return project;\n    });\n\n    return NextResponse.json({ success: true, data: result });\n  } catch (error) {\n    console.error('Error creating project:', error);\n    if (error instanceof z.ZodError) {\n      return NextResponse.json(\n        { success: false, error: 'Validation error', details: error.errors },\n        { status: 400 }\n      );\n    }\n    return NextResponse.json(\n      { success: false, error: 'Failed to create project' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}