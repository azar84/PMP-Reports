{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///Users/azarmacbook/Cursor%20Projects/PMP-%20Reports/src/lib/cloudinary.ts"],"sourcesContent":["import { v2 as cloudinary } from 'cloudinary';\nimport { prisma } from './db';\n\n// Function to get Cloudinary config from database\nexport async function getCloudinaryConfig() {\n  try {\n    console.log('Getting Cloudinary configuration from database...');\n    \n    // Test database connection first\n    try {\n      await prisma.$connect();\n      console.log('Database connection successful');\n    } catch (dbError) {\n      console.error('Database connection failed:', dbError);\n      throw new Error('Database connection failed - cannot retrieve Cloudinary configuration');\n    }\n    \n    // Get settings from database\n    const settings = await prisma.siteSettings.findFirst();\n    console.log('Site settings loaded:', {\n      hasSettings: !!settings,\n      cloudinaryEnabled: settings?.cloudinaryEnabled,\n      hasCloudName: !!settings?.cloudinaryCloudName,\n      hasApiKey: !!settings?.cloudinaryApiKey,\n      hasApiSecret: !!settings?.cloudinaryApiSecret\n    });\n    \n    if (settings?.cloudinaryEnabled && settings.cloudinaryCloudName && settings.cloudinaryApiKey && settings.cloudinaryApiSecret) {\n      console.log('Using database Cloudinary configuration');\n      return {\n        cloud_name: settings.cloudinaryCloudName,\n        api_key: settings.cloudinaryApiKey,\n        api_secret: settings.cloudinaryApiSecret,\n      };\n    }\n    \n    console.log('No Cloudinary configuration found in database');\n    console.log('Please configure Cloudinary in the admin panel under Site Settings');\n    return null;\n  } catch (error) {\n    console.error('Error getting Cloudinary config from database:', error);\n    throw new Error('Failed to retrieve Cloudinary configuration from database');\n  }\n}\n\n// Function to configure Cloudinary with database settings or environment variables\nexport async function configureCloudinary() {\n  try {\n    const config = await getCloudinaryConfig();\n    \n    if (!config) {\n      console.warn('Cloudinary not configured - media uploads will be disabled');\n      return false;\n    }\n    \n    // Validate the configuration\n    if (!config.cloud_name || !config.api_key || !config.api_secret) {\n      console.error('Invalid Cloudinary configuration - missing required fields');\n      return false;\n    }\n    \n    // Configure Cloudinary\n    cloudinary.config(config);\n    \n    // Test the configuration by making a simple API call\n    try {\n      // This is a lightweight test to verify credentials\n      await new Promise((resolve, reject) => {\n        cloudinary.api.ping((error, result) => {\n          if (error) {\n            console.error('Cloudinary ping failed:', error);\n            reject(error);\n          } else {\n            console.log('Cloudinary configuration verified successfully');\n            resolve(result);\n          }\n        });\n      });\n    } catch (pingError) {\n      console.error('Cloudinary configuration test failed:', pingError);\n      return false;\n    }\n    \n    return true;\n  } catch (error) {\n    console.error('Failed to configure Cloudinary:', error);\n    return false;\n  }\n}\n\n// Don't initialize Cloudinary configuration at module level\n// It will be configured when needed\n\nexport interface CloudinaryUploadResult {\n  public_id: string;\n  secure_url: string;\n  url: string;\n  width?: number;\n  height?: number;\n  format: string;\n  resource_type: string;\n  bytes: number;\n}\n\nexport const uploadToCloudinary = async (\n  file: any, // Changed from File | Buffer to any to handle both browser File and Node.js Buffer\n  options: {\n    folder?: string;\n    public_id?: string;\n    resource_type?: 'image' | 'video' | 'raw';\n    transformation?: any[];\n  } = {}\n): Promise<CloudinaryUploadResult> => {\n  try {\n    console.log('Starting Cloudinary upload...');\n    \n    // Ensure Cloudinary is configured\n    const isConfigured = await configureCloudinary();\n    \n    if (!isConfigured) {\n      throw new Error('Cloudinary is not configured. Please configure Cloudinary in site settings or environment variables.');\n    }\n\n    // Convert File to buffer if needed\n    let buffer: Buffer;\n    if (file && typeof file.arrayBuffer === 'function') {\n      // This is a browser File object\n      console.log('Converting File to buffer...');\n      const arrayBuffer = await file.arrayBuffer();\n      buffer = Buffer.from(arrayBuffer);\n      console.log(`File converted to buffer, size: ${buffer.length} bytes`);\n    } else if (Buffer.isBuffer(file)) {\n      // This is already a Buffer\n      buffer = file;\n      console.log(`Using provided buffer, size: ${buffer.length} bytes`);\n    } else {\n      throw new Error('Invalid file type provided');\n    }\n\n    // Validate buffer\n    if (!buffer || buffer.length === 0) {\n      throw new Error('Empty file buffer provided');\n    }\n\n    console.log('Uploading to Cloudinary with options:', {\n      folder: options.folder || 'pmp-reports',\n      resource_type: options.resource_type || 'auto',\n      public_id: options.public_id\n    });\n\n    // Upload to Cloudinary\n    const result = await new Promise<CloudinaryUploadResult>((resolve, reject) => {\n      const uploadStream = cloudinary.uploader.upload_stream(\n        {\n          folder: options.folder || 'pmp-reports',\n          public_id: options.public_id,\n          resource_type: options.resource_type || 'auto',\n          transformation: options.transformation,\n        },\n        (error, result) => {\n          if (error) {\n            console.error('Cloudinary upload stream error:', error);\n            reject(error);\n          } else {\n            console.log('Cloudinary upload successful:', {\n              public_id: result?.public_id,\n              secure_url: result?.secure_url,\n              bytes: result?.bytes\n            });\n            resolve(result as CloudinaryUploadResult);\n          }\n        }\n      );\n\n      uploadStream.end(buffer);\n    });\n\n    return result;\n  } catch (error) {\n    console.error('Cloudinary upload error:', error);\n    \n    // Provide more specific error messages\n    if (error instanceof Error) {\n      if (error.message.includes('not configured')) {\n        throw new Error('Cloudinary is not configured. Please configure Cloudinary in site settings or environment variables.');\n      } else if (error.message.includes('Invalid API key')) {\n        throw new Error('Invalid Cloudinary API key. Please check your credentials.');\n      } else if (error.message.includes('Invalid signature')) {\n        throw new Error('Invalid Cloudinary API secret. Please check your credentials.');\n      } else if (error.message.includes('Cloud name')) {\n        throw new Error('Invalid Cloudinary cloud name. Please check your configuration.');\n      } else if (error.message.includes('Empty file buffer')) {\n        throw new Error('The uploaded file is empty or corrupted.');\n      } else {\n        throw new Error(`Cloudinary upload failed: ${error.message}`);\n      }\n    }\n    \n    throw new Error('Failed to upload file to Cloudinary');\n  }\n};\n\nexport const deleteFromCloudinary = async (public_id: string): Promise<void> => {\n  try {\n    // Ensure Cloudinary is configured\n    const isConfigured = await configureCloudinary();\n    \n    if (!isConfigured) {\n      console.warn('Cloudinary is not configured - skipping delete operation');\n      return;\n    }\n    \n    await cloudinary.uploader.destroy(public_id);\n  } catch (error) {\n    console.error('Cloudinary delete error:', error);\n    throw new Error('Failed to delete file from Cloudinary');\n  }\n};\n\nexport const getCloudinaryUrl = (public_id: string, options: {\n  transformation?: any[];\n  format?: string;\n} = {}): string => {\n  // This function doesn't need configuration check as it just generates URLs\n  // But we should ensure Cloudinary is configured for consistency\n  try {\n    // Note: This is a synchronous operation, so we can't await configureCloudinary\n    // The URL generation should work even without full configuration\n    return cloudinary.url(public_id, {\n      secure: true,\n      ...options,\n    });\n  } catch (error) {\n    console.error('Error generating Cloudinary URL:', error);\n    // Return a fallback URL or the original public_id\n    return public_id;\n  }\n}; "],"names":[],"mappings":"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","debugId":null}}]
}