{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 61, "column": 0}, "map": {"version":3,"sources":["file:///Users/azarmacbook/Cursor%20Projects/PMP-%20Reports/src/lib/db.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient();\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma; "],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,kBAAkB;AAIjB,MAAM,SAAS,gBAAgB,MAAM,IAAI,IAAI,6IAAY;AAEhE,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 74, "column": 0}, "map": {"version":3,"sources":["file:///Users/azarmacbook/Cursor%20Projects/PMP-%20Reports/src/app/api/admin/project-staff/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { prisma } from '@/lib/db';\nimport { z } from 'zod';\n\n// Schema for creating a project position\nconst createPositionSchema = z.object({\n  projectId: z.number().int().positive(),\n  designation: z.string().min(1, 'Designation is required'),\n  requiredUtilization: z.number().int().min(0).default(100), // Required total utilization for this position\n});\n\n// Schema for assigning staff to a position\nconst assignStaffSchema = z.object({\n  positionId: z.number().int().positive(),\n  staffId: z.number().int().positive(),\n  utilization: z.number().int().min(0).default(100), // Staff utilization percentage\n  startDate: z.string().optional().nullable().or(z.literal('')),\n  endDate: z.string().optional().nullable().or(z.literal('')),\n  status: z.string().default('Active'),\n  notes: z.string().optional().nullable().or(z.literal('')),\n});\n\n// GET - Fetch project positions with their staff assignments\nexport async function GET(request: NextRequest) {\n  try {\n    const { searchParams } = new URL(request.url);\n    const projectId = searchParams.get('projectId');\n\n    if (!projectId) {\n      return NextResponse.json(\n        { success: false, error: 'Project ID is required' },\n        { status: 400 }\n      );\n    }\n\n    const projectPositions = await prisma.projectPosition.findMany({\n      where: { projectId: parseInt(projectId) },\n      include: {\n        staffAssignments: {\n          include: {\n            staff: true,\n          },\n          orderBy: {\n            createdAt: 'asc',\n          },\n        },\n        project: {\n          select: {\n            id: true,\n            projectName: true,\n            projectCode: true,\n          },\n        },\n      },\n      orderBy: [\n        { designation: 'asc' },\n      ],\n    });\n\n    // Fetch monthly rates from positions table and merge with project positions\n    const positionsWithRates = await Promise.all(\n      projectPositions.map(async (position) => {\n        const positionData = await prisma.position.findUnique({\n          where: { name: position.designation },\n          select: { monthlyRate: true },\n        });\n        \n        return {\n          ...position,\n          monthlyRate: positionData?.monthlyRate || null,\n        };\n      })\n    );\n\n    // Custom sorting: Project Director first, then Project Manager, then alphabetical\n    const sortedPositions = positionsWithRates.sort((a, b) => {\n      // Project Director always first\n      if (a.designation === 'Project Director' && b.designation !== 'Project Director') {\n        return -1;\n      }\n      if (b.designation === 'Project Director' && a.designation !== 'Project Director') {\n        return 1;\n      }\n      \n      // Project Manager second (but only if Project Director is not present)\n      if (a.designation === 'Project Manager' && b.designation !== 'Project Manager' && b.designation !== 'Project Director') {\n        return -1;\n      }\n      if (b.designation === 'Project Manager' && a.designation !== 'Project Manager' && a.designation !== 'Project Director') {\n        return 1;\n      }\n      \n      // For all other cases, maintain alphabetical order\n      return a.designation.localeCompare(b.designation);\n    });\n\n    return NextResponse.json({\n      success: true,\n      data: sortedPositions,\n      message: 'Project positions retrieved successfully',\n    });\n  } catch (error) {\n    console.error('Error fetching project positions:', error);\n    return NextResponse.json(\n      { success: false, error: 'Failed to fetch project positions' },\n      { status: 500 }\n    );\n  }\n}\n\n// POST - Create a new position or assign staff to existing position\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    \n    // Check if this is a position creation or staff assignment\n    if (body.positionId) {\n      // This is a staff assignment to an existing position\n      const validatedData = assignStaffSchema.parse(body);\n\n      // Check if the same staff member is already assigned to this project\n      const existingStaffAssignment = await prisma.projectStaff.findFirst({\n        where: {\n          projectId: {\n            // We need to get the projectId from the position\n            in: await prisma.projectPosition.findMany({\n              where: { id: validatedData.positionId },\n              select: { projectId: true },\n            }).then(positions => positions.map(p => p.projectId)),\n          },\n          staffId: validatedData.staffId,\n        },\n      });\n\n      if (existingStaffAssignment) {\n        return NextResponse.json(\n          { success: false, error: 'This staff member is already assigned to this project' },\n          { status: 400 }\n        );\n      }\n\n      // Get the position to get the projectId\n      const position = await prisma.projectPosition.findUnique({\n        where: { id: validatedData.positionId },\n        select: { projectId: true },\n      });\n\n      if (!position) {\n        return NextResponse.json(\n          { success: false, error: 'Position not found' },\n          { status: 404 }\n        );\n      }\n\n      const staffAssignment = await prisma.projectStaff.create({\n        data: {\n          projectId: position.projectId,\n          positionId: validatedData.positionId,\n          staffId: validatedData.staffId,\n          utilization: validatedData.utilization,\n          startDate: validatedData.startDate && validatedData.startDate !== '' ? new Date(validatedData.startDate) : null,\n          endDate: validatedData.endDate && validatedData.endDate !== '' ? new Date(validatedData.endDate) : null,\n          status: validatedData.status,\n          notes: validatedData.notes && validatedData.notes !== '' ? validatedData.notes : null,\n        },\n        include: {\n          staff: true,\n          position: true,\n          project: {\n            select: {\n              id: true,\n              projectName: true,\n              projectCode: true,\n            },\n          },\n        },\n      });\n\n      return NextResponse.json({\n        success: true,\n        data: staffAssignment,\n        message: 'Staff assigned to position successfully',\n      });\n    } else {\n      // This is creating a new position\n      const validatedData = createPositionSchema.parse(body);\n\n      // Check if position already exists for this project\n      const existingPosition = await prisma.projectPosition.findFirst({\n        where: {\n          projectId: validatedData.projectId,\n          designation: validatedData.designation,\n        },\n      });\n\n      if (existingPosition) {\n        return NextResponse.json(\n          { success: false, error: 'This position already exists for this project' },\n          { status: 400 }\n        );\n      }\n\n      const position = await prisma.projectPosition.create({\n        data: {\n          projectId: validatedData.projectId,\n          designation: validatedData.designation,\n          requiredUtilization: validatedData.requiredUtilization,\n        },\n        include: {\n          staffAssignments: {\n            include: {\n              staff: true,\n            },\n          },\n          project: {\n            select: {\n              id: true,\n              projectName: true,\n              projectCode: true,\n            },\n          },\n        },\n      });\n\n      return NextResponse.json({\n        success: true,\n        data: position,\n        message: 'Position created successfully',\n      });\n    }\n  } catch (error) {\n    console.error('Error creating position or assigning staff:', error);\n    if (error instanceof z.ZodError) {\n      return NextResponse.json(\n        { success: false, error: 'Validation error', details: error.errors },\n        { status: 400 }\n      );\n    }\n    return NextResponse.json(\n      { success: false, error: 'Failed to create position or assign staff' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}